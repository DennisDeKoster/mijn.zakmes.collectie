<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mijn zakmes collectie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Space+Grotesk:wght@400;700&family=Sora:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script>
        async function loadKnives() {
            const response = await fetch('database.json');
            const text = await response.text(); 
            const knives = JSON.parse(text);
            const container = document.getElementById('knifeContainer');
            container.innerHTML = '';
            knives.forEach(knife => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.innerHTML = `
                    <div class="card-content">
                        <label class="select-checkbox">
                            <input type="checkbox" class="daily-carry-checkbox" data-id="${knife.id}">
                            Vandaag op zak
                        </label>
                        <div class="specs">
                            <h2><span class="merk">${knife.merk}</span> <span class="naam">${knife.naam}</span></h2>
                            <a href="${knife.link}" target="_blank">
                                <img src="${knife.afbeelding}" alt="${knife.naam}">
                            </a>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getTodayKey() {
            const today = new Date();
            return `selectedKnife-${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }

        function getCookie(name) {
            return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
        }

        function saveSelectedKnife(knifeId) {
            setCookie(getTodayKey(), knifeId, 1);
        }

        function getSelectedKnife() {
            return getCookie(getTodayKey());
        }

        function setupCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.daily-carry-checkbox');
            const selectedId = getSelectedKnife();
            checkboxes.forEach(checkbox => {
                const thisId = checkbox.dataset.id;
                checkbox.checked = thisId === selectedId;
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        checkboxes.forEach(cb => {
                            if (cb !== checkbox) cb.checked = false;
                        });
                        saveSelectedKnife(thisId);
                        moveCardToTop(thisId);
                    } else {
                        saveSelectedKnife('');
                    }
                });
            });
            if (selectedId) {
                moveCardToTop(selectedId);
            }
        }

        function moveCardToTop(knifeId) {
            const container = document.getElementById('knifeContainer');
            const cards = Array.from(container.children);
            const selectedCard = cards.find(card => {
                const checkbox = card.querySelector('.daily-carry-checkbox');
                return checkbox && checkbox.dataset.id === knifeId;
            });
            if (selectedCard) {
                container.prepend(selectedCard);
            }
        }

        function sortKnives() {
            const sortBy = document.getElementById('sort').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const container = document.getElementById('knifeContainer');
            const cards = Array.from(container.children);
            cards.sort((a, b) => {
                let aValue = a.querySelector(`.${sortBy}`).textContent.trim();
                let bValue = b.querySelector(`.${sortBy}`).textContent.trim();
                if (sortBy === 'aankoopdatum') {
                    aValue = new Date(aValue.split('-').reverse().join('-'));
                    bValue = new Date(bValue.split('-').reverse().join('-'));
                    return sortOrder === 'asc' ? aValue - bValue : bValue - aValue;
                } else {
                    return sortOrder === 'asc'
                        ? aValue.localeCompare(bValue, undefined, { numeric: true })
                        : bValue.localeCompare(aValue, undefined, { numeric: true });
                }
            });
            container.innerHTML = '';
            cards.forEach(card => container.appendChild(card));
            const selectedId = getSelectedKnife();
            if (selectedId) moveCardToTop(selectedId);
        }

        function resetAtMidnight() {
            const now = new Date();
            const millisTillMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0) - now;
            setTimeout(() => {
                saveSelectedKnife('');
                document.querySelectorAll('.daily-carry-checkbox').forEach(cb => cb.checked = false);
                resetAtMidnight();
            }, millisTillMidnight);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadKnives();
            setupCheckboxListeners();
            resetAtMidnight();
        });
    </script>
</head>
<body>
    <div class="header">
        <h1>Mijn zakmes collectie</h1>
        <div id="totalKnives"></div>
        <div id="totalValue"></div>
    </div>
    <div class="controls">
        <input type="text" id="search" placeholder="Zoeken...">
        <select id="sort">
            <option value="aankoopdatum">Aankoopdatum</option>
            <option value="merk">Merk</option>
        </select>
        <select id="sortOrder">
            <option value="asc">Oplopend</option>
            <option value="desc">Aflopend</option>
        </select>
    </div>
    <div id="knifeContainer" class="container"></div>
</body>
</html>
